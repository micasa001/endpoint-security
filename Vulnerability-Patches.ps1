### /CMD Hardening

# Define registry settings to check and update
$registrySettings = @(
    @{
        Path = "HKLM:\SOFTWARE\Policies\Adobe\Adobe Acrobat\DC\FeatureLockDown"
        Name = "bDisableJavaScript"
        Value = 1
    },
    @{
        Path = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"
        Name = "DisableDomainCreds"
        Value = 1
    },
    @{
        Path = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"
        Name = "RunAsPPL"
        Value = 1
    },
    @{
        Path = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"
        Name = "RestrictAnonymous"
        Value = 1
    },
    @{
        Path = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa"
        Name = "LmCompatibilityLevel"
        Value = 5
    },
    @{
        Path = "HKLM:\SYSTEM\CurrentControlSet\Services\LanmanWorkstation\Parameters"
        Name = "RequireSecuritySignature"
        Value = 1
    },
    @{
        Path = "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip\Parameters"
        Name = "DisableIPSourceRouting"
        Value = 2
    },
    @{
        Path = "HKLM:\SYSTEM\CurrentControlSet\Services\Tcpip6\Parameters"
        Name = "DisableIPSourceRouting"
        Value = 2
    },
    @{
        Path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services"
        Name = "fAllowToGetHelp"
        Value = 0
    },
    @{
        Path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Explorer"
        Name = "NoAutoplayfornonVolume"
        Value = 1
    },
    @{
        Path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service"
        Name = "AllowBasic"
        Value = 0
    },
    @{
        Path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client"
        Name = "AllowBasic"
        Value = 0
    },
    @{
        Path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Network Connections"
        Name = "NC_ShowSharedAccessUI"
        Value = 0
    },
    @{
        Path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Network Connections"
        Name = "NC_AllowNetBridge_NLA"
        Value = 0
    },
    @{
        Path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\Network Connections"
        Name = "NC_StdDomainUserSetLocation"
        Value = 1
    },
    @{
        Path = "HKLM:\SOFTWARE\Policies\Microsoft Services\AdmPwd"
        Name = "AdmPwdEnabled"
        Value = 1
    },
    @{
        Path = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer"
        Name = "NoAutorun"
        Value = 1
    },
    @{
        Path = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\Explorer"
        Name = "NoDriveTypeAutoRun"
        Value = 255
    },
	    @{
        Path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services"
        Name = "UserAuthentication"
        Value = 1
    },
    @{
        # Ensure 'Do not allow passwords to be saved' - this is related to Windows RDP services	
        Path = "HKLM:\Software\Policies\Microsoft\Windows NT\Terminal Services"
        Name = "DisablePasswordSaving"
        Value = 1
    },
    @{
        # Ensure 'Prohibit installation and configuration of Network Bridge on your DNS domain network' is enabled. 
        Path = "HKLM:\Software\Policies\Microsoft\Windows\Network Connections"
        Name = "NC_AllowNetBridge_NL"
        Value = 0
    },
    @{
        # Ensure 'Network access: Do not allow storage of passwords and credentials for network authentication' is enabled. 
        Path = "HKLM:\System\CurrentControlSet\Control\Lsa"
        Name = "DisableDomainCreds"
        Value = 1
    },
    @{
        # DoNotAllowPasswordSaving. 
        Path = "HKLM:\SOFTWARE\Microsoft\PolicyManager\providers\5B88AEF1-09E8-43BB-B144-7254ACBBDFF3E\default\Device\RemoteDesktopServices"
        Name = "DoNotAllowPasswordSaving"
        Value = 1
    },
    @{
        # Enable Local Admin password management
        Path = "HKLM:\Software\Policies\Microsoft Services\AdmPwd"
        Name = "AdmPwdEnabled"
        Value = 1
    },
    @{
        # Disable merging of local Microsoft Defender Firewall connection rules with group policy firewall rules for the Public profile
        Path = "HKLM:\SOFTWARE\Policies\Microsoft\WindowsFirewall\PublicProfile"
        Name = "AllowLocalIPsecPolicyMerge"
        Value = 0
    },
    @{
        # Disable Microsoft Defender Firewall notifications when programs are blocked for Public profile
        Path = "HKLM:\Software\Policies\Microsoft\WindowsFirewall\DomainProfile"
        Name = "DisableNotifications"
        Value = 1
    },
    @{
        # Disable Microsoft Defender Firewall notifications when programs are blocked for Public profile
        Path = "HKLM:\Software\Policies\Microsoft\WindowsFirewall\StandardProfile"
        Name = "DisableNotifications"
        Value = 1
    },
    @{
        # Disable Fast Boot
        Path = "HKLM:\SYSTEM\CurrentControlSet\Control\Session Manager\Power"
        Name = "HiberbootEnabled"
        Value = 0
    },
	@{
        # Set controlled folder access to enabled or audit mode
        Path = "HKLM:\Software\Policies\Microsoft\Windows Defender\Windows Defender Exploit Guard\Controlled Folder Access"
        Name = "EnableControlledFolderAccess"
        Value = 1
    },
	@{
        # Disable 'Enumerate administrator accounts on elevation'
        Path = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\CredUI"
        Name = "EnumerateAdministrators"
        Value = 0
    },
    @{
        Path = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System"
        Name = "LocalAccountTokenFilterPolicy"
        Value = 0
    },
	@{
        Path = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System"
        Name = "ConsentPromptBehaviorUser"
        Value = 0
    },
	@{
        Path = "HKLM:\SOFTWARE\Microsoft\Office\16.0\Common\COM Compatibility\{D27CDB6E-AE6D-11CF-96B8-444553540000}"
        Name = "activationfilteroverride"
        Value = 0
    },
	@{
        Path = "HKLM:\SOFTWARE\Microsoft\Office\16.0\Common\COM Compatibility\{D27CDB70-AE6D-11CF-96B8-444553540000}"
        Name = "activationfilteroverride"
        Value = 0
    },
	@{
        Path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Client"
        Name = "AllowBasic"
        Value = 0
    },
	@{
        Path = "HKLM:\SOFTWARE\Policies\Microsoft\Windows\WinRM\Service"
        Name = "AllowBasic"
        Value = 0
    },
	@{
        Path = "HKLM:\SOFTWARE\policies\Microsoft\office\16.0\common\officeupdate"
        Name = "enableautomaticupdates"
        Value = 1
    },
	@{
        Path = "HKLM:\SOFTWARE\policies\Microsoft\office\16.0\common\officeupdate"
        Name = "hideenabledisableupdates"
        Value = 1
    },
	@{
        Path = "HKLM:\SOFTWARE\Policies\Microsoft\FVE"
        Name = "UseAdvancedStartup"
        Value = 1
    },
	@{
        Path = "HKLM:\SOFTWARE\MPolicies\Microsoft\Windows Defender\Windows Defender Exploit Guard\Controlled Folder Access"
        Name = "EnableControlledFolderAccess"
        Value = 1
    },
	@{
        Path = "HKLM:\SOFTWARE\Policies\Microsoft\FVE"
        Name = "MinimumPIN"
        Value = 6
    }
)

# Loop through each registry setting
foreach ($setting in $registrySettings) {
    $path = $setting["Path"]
    $name = $setting["Name"]
    $value = $setting["Value"]

    # Check if the registry value exists
    if (Test-Path $path) {
        $currentValue = (Get-ItemProperty -Path $path -Name $name -ErrorAction SilentlyContinue).$name

        # If the registry value doesn't exist or doesn't match the required value, update it
        if ($currentValue -eq $null -or $currentValue -ne $value) {
            Write-Host "Updating registry value: $path\$name to $value"
            New-ItemProperty -Path $path -Name $name -Value $value -PropertyType DWORD -Force | Out-Null
        } else {
            Write-Host "Registry value: $path\$name is already set to $value"
        }
    } else {
        Write-Host "Registry path not found: $path"
    }
}
